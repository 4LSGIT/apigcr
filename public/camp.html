<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unlayer Email Editor</title>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet"> <!-- If needed for subject, but we'll use input -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
    #editor-container { height: 500px; width: 100%; border: 1px solid #ccc; }
    .campaign-form { display: flex; flex-direction: column; gap: 10px; }
    .campaign-hidden { display: none; }
    .input-label { font-weight: bold; }
    .input { width: 100%; padding: 8px; box-sizing: border-box; }
    .input-ta { width: 100%; padding: 8px; box-sizing: border-box; resize: vertical; }
    .checkbox-group { display: flex; gap: 20px; }
    .big-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; }
    .big-button:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <div class="campaign-form">
    <div class="checkbox-group">
      <label><input type="checkbox" id="campaign-email-checkbox" checked onchange="toggleFields()"> Email</label>
      <label><input type="checkbox" id="campaign-sms-checkbox" onchange="toggleFields()"> SMS</label>
    </div>
    <div id="campaign-email-fields">
      <div class="input-label">Email Subject:</div>
      <input id="campaign-email-subject" class="input" placeholder="Enter email subject">
      <div class="input-label">Email Body:</div>
      <div id="editor-container"></div> <!-- Unlayer editor here -->
    </div>
    <div id="campaign-sms-fields" class="campaign-hidden">
      <div class="input-label">SMS Body:</div>
      <textarea id="campaign-sms-body" class="input-ta" rows="3" placeholder="Enter SMS body (max 160 characters)" maxlength="160"></textarea>
    </div>
    <label><input type="checkbox" id="campaign-send-now" checked onchange="toggleSchedule()"> Send Now</label>
    <div id="campaign-schedule-field" class="campaign-hidden">
      <div class="input-label">Schedule Date/Time:</div>
      <input type="datetime-local" id="campaign-schedule" class="input">
    </div>
    <button class="big-button" onclick="scheduleCampaign()">Schedule Campaign</button>
  </div>

  <!-- Unlayer Embed Script -->
  <script src="https://editor.unlayer.com/embed.js"></script>
  <script>
    let editor;
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Unlayer
      unlayer.init({
        id: 'editor-container',
        projectId: 282533, // Replace with your Unlayer project ID (sign up at unlayer.com for free tier)
        displayMode: 'email',
        mergeTags: {
          'client.first_name': {
            name: 'Client First Name',
            value: '{{client.first_name}}',
            sample: 'John'
          },
          'client.last_name': {
            name: 'Client Last Name',
            value: '{{client.last_name}}',
            sample: 'Doe'
          },
          'client.email': {
            name: 'Client Email',
            value: '{{client.email}}',
            sample: 'john@example.com'
          },
          'client.phone': {
            name: 'Client Phone',
            value: '{{client.phone}}',
            sample: '(123) 456-7890'
          },
          // Add more placeholders as needed based on your contacts table
        },
        appearance: {
          theme: 'light' // or 'dark'
        },
        // Custom image upload handler to your Node server
        customFileUpload: function(file, handleSuccess, handleError, handleProgress) {
          const formData = new FormData();
          formData.append('image', file);
          fetch('/upload-image', { // Your Node endpoint
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            handleSuccess(data.url); // e.g., { url: 'https://yourdomain.com/uploads/image.jpg' }
          })
          .catch(err => {
            handleError('Upload failed: ' + err.message);
          });
          // Optional progress: handleProgress(percent);
        }
      });

      // For exporting, etc.
      editor = unlayer; // Since init returns the instance

      // Toggle fields (similar to your original)
      toggleFields();
      toggleSchedule();
    });

    function toggleFields() {
      const emailCheckbox = document.getElementById('campaign-email-checkbox');
      const smsCheckbox = document.getElementById('campaign-sms-checkbox');
      const emailFields = document.getElementById('campaign-email-fields');
      const smsFields = document.getElementById('campaign-sms-fields');
      emailFields.classList.toggle('campaign-hidden', !emailCheckbox.checked);
      smsFields.classList.toggle('campaign-hidden', !smsCheckbox.checked);
    }

    function toggleSchedule() {
      const sendNow = document.getElementById('campaign-send-now').checked;
      const scheduleField = document.getElementById('campaign-schedule-field');
      scheduleField.classList.toggle('campaign-hidden', sendNow);
    }

    function scheduleCampaign() {
      const emailCheckbox = document.getElementById('campaign-email-checkbox').checked;
      const smsCheckbox = document.getElementById('campaign-sms-checkbox').checked;
      const emailSubject = document.getElementById('campaign-email-subject').value;
      const smsBody = document.getElementById('campaign-sms-body').value;
      const sendNow = document.getElementById('campaign-send-now').checked;
      const schedule = sendNow ? new Date().toISOString() : document.getElementById('campaign-schedule').value;

      // Get selected contacts from parent (you'll need to expose this function in parent)
      const selectedContacts = window.parent.getSelectedContacts(); // Implement in parent: returns array of contact_ids

      // Validation (similar to original)
      if (!emailCheckbox && !smsCheckbox) {
        alert('Please select at least one campaign type (Email or SMS).');
        return;
      }
      if (emailCheckbox && !emailSubject) {
        alert('Please fill in the email subject.');
        return;
      }
      if (smsCheckbox && !smsBody) {
        alert('Please fill in the SMS body.');
        return;
      }
      if (!sendNow && !schedule) {
        alert('Please specify a schedule date/time or check "Send Now".');
        return;
      }
      if (!selectedContacts || selectedContacts.length === 0) {
        alert('Please select at least one contact.');
        return;
      }

      // Export email body from Unlayer if email selected
      let emailBody = '';
      if (emailCheckbox) {
        editor.exportHtml((data) => {
          emailBody = data.html; // Inlined HTML ready for email
          // Now proceed to schedule
          proceedToSchedule(emailSubject, emailBody, smsBody, schedule, selectedContacts);
        });
        return; // Wait for async export
      } else {
        proceedToSchedule(emailSubject, emailBody, smsBody, schedule, selectedContacts);
      }
    }

    function proceedToSchedule(emailSubject, emailBody, smsBody, schedule, selectedContacts) {
      const campaigns = [];
      if (document.getElementById('campaign-email-checkbox').checked) {
        campaigns.push({
          type: 'email',
          subject: emailSubject.replace(/'/g, "''"),
          body: emailBody.replace(/'/g, "''"),
          schedule: schedule
        });
      }
      if (document.getElementById('campaign-sms-checkbox').checked) {
        campaigns.push({
          type: 'sms',
          subject: '',
          body: smsBody.replace(/'/g, "''"),
          schedule: schedule
        });
      }

      campaigns.forEach(campaign => {
        const q = `INSERT INTO campaigns (type, subject, body, schedule, contact_ids) VALUES ('${campaign.type}', '${campaign.subject}', '${campaign.body}', '${campaign.schedule}', '${selectedContacts.join(',')}')`;
        console.log('Scheduling campaign with query:', q);
        window.parent.sendQuery(q) // Use parent's sendQuery
          .then(response => {
            alert('Campaign scheduled successfully!'); // Or use Toast if available in parent
          })
          .catch(error => {
            console.error('Failed to schedule campaign:', error);
            alert('Failed to schedule campaign. Please try again.');
          });
      });
    }

    // Optional: Auto-save design to parent or localStorage
    unlayer.registerCallback('design:updated', (data) => {
      // Could export and save periodically
      console.log('Design updated');
    });

    // Expose functions if parent needs to call child (e.g., load existing campaign)
    window.loadDesign = function(designJson) {
      unlayer.loadDesign(JSON.parse(designJson));
    };
    window.setSubject = function(subject) {
      document.getElementById('campaign-email-subject').value = subject;
    };
    // Add more as needed for editing existing campaigns
  </script>
</body>
</html>
