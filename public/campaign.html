<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campaigns</title>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
  <!--<link rel="stylesheet" type="text/css" href="style.css" />-->
  <style>
    body {
  font-family: Arial, Helvetica, sans-serif;
}
.active {
  background-color: #aaaaaa;
}
input, select, .input-ta, .input {
  width: 200px;
  box-sizing: border-box;
  padding: 10px;
  border: 1px solid #cccccc;
  border-radius: 3px;
}
.input-label {
  vertical-align: top;
  margin-top: 10px;
  font-weight: bold;
  margin-bottom: 5px;
  text-align: right;
  width: 150px;
  display: inline-block;
}
.big-button {
  display: inline-block;
  padding: 10px 20px;
  background-color: #007bff;
  color: #ffffff;
  text-decoration: none;
  border-radius: 3px;
  transition: background-color 0.3s ease;
  width: 170px;
}
.big-button:hover {
  background-color: #0056b3;
}
.logTable {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}
.logTable td, .logTable th {
  border: 1px solid #dddddd;
  padding: 8px;
}
.logTable th {
  background-color: #26abe2; /* or #04AA6D if preferred */
  color: white;
}
.logTable tr:nth-child(even) {
  background-color: #f2f2f2;
}
.logTable tr:hover {
  background-color: #dddddd;
}
/* Campaign-specific styles */
.campaign-tab-header {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}
.campaign-tab-button {
  padding: 10px 20px;
  background-color: #f2f2f2;
  border: 1px solid #cccccc;
  border-bottom: none;
  cursor: pointer;
  font-weight: bold;
}
.campaign-tab-button.active {
  background-color: #ffffff;
  border-bottom: 2px solid #007bff;
}
.campaign-tab-main {
  display: none;
  padding: 20px;
  border: 1px solid #cccccc;
  background-color: #ffffff;
}
.campaign-tab-main.active {
  display: block;
}
.campaign-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 800px;
}
.campaign-form .input-label {
  font-weight: bold;
}
.campaign-form input, .campaign-form textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #cccccc;
  border-radius: 3px;
  box-sizing: border-box;
}
.campaign-form .radio-group {
  display: flex;
  gap: 20px;
}
.campaign-form .schedule-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.campaign-hidden {
  display: none;
}
    .quill-editor .ql-container {
      border: 1px solid #cccccc;
      border-radius: 3px;
      box-sizing: border-box;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
    }
    #campaign-email-subject-editor .ql-container {
      height: 20px;
      padding: 8px;
    }
    #campaign-email-body-editor .ql-container {
      height: 300px;
      padding: 8px;
    }
    .quill-editor .ql-toolbar {
      border: 1px solid #cccccc;
      border-bottom: none;
      border-radius: 3px 3px 0 0;
      background-color: #f2f2f2;
    }
    #subject-hint {
      font-size: 12px;
      margin-top: 4px;
      text-align: left;
    }
  </style>
</head>
<body style="text-align: center">
  <h2>Campaigns</h2>
  <div id="campaign-container">
    <!-- Tab Header -->
    <div class="campaign-tab-header">
      <button class="campaign-tab-button active" onclick="campaignShowTab('campaign-tab-reports')">Select Contacts</button>
      <button class="campaign-tab-button" onclick="campaignShowTab('campaign-tab-compose')">Compose Campaign</button>
      <button class="campaign-tab-button" onclick="campaignShowTab('campaign-tab-scheduled')">Scheduled Campaigns</button>
    </div>
    <!-- Tab: Select Contacts -->
    <div id="campaign-tab-reports" class="campaign-tab-main active">
      <div class="input-label">Required Tags (all):</div>
      <input placeholder="tags separated by comma" id="campaign-report-required-tags" class="input">
      <div class="input-label">Any Tags (at least one):</div>
      <input placeholder="tags separated by comma" id="campaign-report-any-tags" class="input">
      <div class="input-label">Exclude Tags (none):</div>
      <input placeholder="tags separated by comma" id="campaign-report-exclude-tags" class="input">
      <button id="campaign-report-button" class="big-button" onclick="campaignGetForReport()">Get Contacts</button>
      <table id="campaign-reports-table" class="logTable">
        <tr>
          <th>Select</th>
          <th>ID</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
        </tr>
      </table>
    </div>
    <!-- Tab: Compose Campaign -->
    <div id="campaign-tab-compose" class="campaign-tab-main">
      <div class="campaign-form">
        <div class="radio-group">
          <label><input type="radio" name="campaign-type" value="sms" onchange="campaignToggleFields()"> SMS</label>
          <label><input type="radio" name="campaign-type" value="simple-email" checked onchange="campaignToggleFields()"> Simple Email</label>
          <label><input type="radio" name="campaign-type" value="html-email" onchange="campaignToggleFields()"> HTML Email</label>
        </div>
        <div id="campaign-sender-fields">
          <div id="campaign-sms-sender" class="campaign-hidden">
            <div class="input-label">From Phone:</div>
            <select id="campaign-sms-phone" class="input">
              <option value="">Select phone number</option>
              <!-- Populate options dynamically or statically as needed -->
              <option value="+12485592400">+1 (248) 559-2400</option>
              <option value="+12486213656">+1 (248) 621-3656</option>
              <option value="+12345678910">+1 (234) 567-8910 - fail</option>
            </select>
          </div>
          <div id="campaign-email-sender" class="campaign-hidden">
            <div class="input-label">From Email:</div>
            <select id="campaign-email-address" class="input">
              <option value="">Select email address</option>
              <!-- Populate options dynamically or statically as needed -->
              <option value="shoshana@metrodetroitbankruptcylaw.com">shoshana@metrodetroitbankruptcylaw.com</option>
              <option value="support@example.com">support@example.com - fail</option>
            </select>
          </div>
        </div>
        <div id="campaign-subject-fields" class="campaign-hidden">
          <div class="input-label">Email Subject:</div>
          <div style="display:flex; justify-content:center; gap:6px;">
            <input
              id="campaign-email-subject"
              type="text"
              maxlength="150"
              placeholder="Enter subject"
            >
          </div>
          <div id="subject-hint"></div>
        </div>
        <div id="campaign-simple-body-fields" class="campaign-hidden">
          <div class="input-label">Email Body:</div>
          <div id="campaign-email-body-editor" class="quill-editor"></div>
        </div>
        <div id="campaign-html-body-fields" class="campaign-hidden">
          <div class="input-label">HTML Body:</div>
          <textarea id="campaign-html-body" class="input-ta" rows="10" placeholder="Paste HTML here"></textarea>
        </div>
        <div id="campaign-sms-fields" class="campaign-hidden">
          <div class="input-label">SMS Body:</div>
          <textarea id="campaign-sms-body" class="input-ta" rows="3" placeholder="Enter SMS body (max 160 characters)" maxlength="160"></textarea>
        </div>
        <div class="schedule-group">
          <label><input type="checkbox" id="campaign-send-now" checked onchange="campaignToggleSchedule()"> Send Now</label>
          <div id="campaign-schedule-field" class="campaign-hidden">
            <span class="input-label">Or Schedule:</span>
            <input type="datetime-local" id="campaign-schedule" class="input">
          </div>
        </div>
        <button class="big-button" onclick="campaignScheduleCampaign()">Create Campaign</button>
      </div>
    </div>
    <!-- Tab: Scheduled Campaigns -->
    <div id="campaign-tab-scheduled" class="campaign-tab-main">
      <table id="campaign-scheduled-table" class="logTable">
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Subject</th>
          <th>Scheduled Time</th>
          <th>Action</th>
        </tr>
      </table>
    </div>
  </div>
 <script>
const E = (id) => document.getElementById(id);
const p = window.parent;

let quillBody = null;
document.addEventListener('DOMContentLoaded', () => {
  quillBody = new Quill('#campaign-email-body-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link', 'image']
      ]
    },
    placeholder: 'Enter email body'
  });
  campaignToggleFields();
  campaignToggleSchedule();
  E('campaign-email-subject').addEventListener('input', updateSubjectHint);
  updateSubjectHint();
});


async function campaignGetForReport() {
  const requiredInput = E('campaign-report-required-tags').value;
  const anyInput = E('campaign-report-any-tags').value;
  const excludeInput = E('campaign-report-exclude-tags').value;

  const required = requiredInput.split(',').map(t => t.trim()).filter(t => t);
  const any = anyInput.split(',').map(t => t.trim()).filter(t => t);
  const exclude = excludeInput.split(',').map(t => t.trim()).filter(t => t);

  if (!required.length && !any.length) {
    try { p.Toast.fire({ icon: 'error', title: 'Please enter at least one tag in Required or Any fields.' }); } catch (_) {}
    return;
  }

  const makeLike = tag => `(contact_tags='${tag.replace(/'/g,"''")}' OR contact_tags LIKE '${tag},%' OR contact_tags LIKE '%,${tag},%' OR contact_tags LIKE '%,${tag}')`;

  const whereParts = [];
  if (required.length) whereParts.push(required.map(makeLike).join(' AND '));
  if (any.length) whereParts.push('(' + any.map(makeLike).join(' OR ') + ')');
  if (exclude.length) whereParts.push('NOT (' + exclude.map(makeLike).join(' OR ') + ')');

  const query = `SELECT * FROM contacts WHERE ${whereParts.join(' AND ')}`;
  console.log('Executing query:', query);

  const table = E('campaign-reports-table');
  while (table.rows.length > 1) table.deleteRow(1);

  try {
    const response = await p.sendQuery(query);
    const results = response.data.query1;
    if (!Array.isArray(results) || !results.length) {
      const row = table.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 5;
      cell.textContent = 'No results found';
      return;
    }

    results.forEach((contact, index) => {
      const row = table.insertRow();
      const checkboxCell = row.insertCell();
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = true;
      checkbox.id = `campaign-contact-checkbox-${index}`;
      checkboxCell.appendChild(checkbox);

      ['contact_id', 'contact_name', 'contact_phone', 'contact_email', 'contact_tags'].forEach(field => {
        const cell = row.insertCell();
        if (field === 'contact_id') {
          const escapedName = contact.contact_name ? contact.contact_name.replace(/'/g,"\\'") : '';
          cell.innerHTML = `<a href="#" onclick="window.parent.addFile('${escapedName}','contact','${contact.contact_id}')">${contact.contact_id}</a>`;
        } else {
          cell.textContent = contact[field] || '-';
        }
      });
    });
  } catch (err) {
    console.error('Failed to fetch report:', err);
    try { p.Toast.fire({ icon: 'error', title: 'Error fetching report.' }); } catch (_) {}
  }
}

// Tab switching
function campaignShowTab(tabId) {
  document.querySelectorAll('.campaign-tab-button').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.campaign-tab-main').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`button[onclick="campaignShowTab('${tabId}')"]`).classList.add('active');
  E(tabId).classList.add('active');
}

// Field toggling
function campaignToggleFields() {
  const type = document.querySelector('input[name="campaign-type"]:checked')?.value || 'simple-email';
  const smsSender = E('campaign-sms-sender'), emailSender = E('campaign-email-sender');
  const subjectFields = E('campaign-subject-fields'), simpleBodyFields = E('campaign-simple-body-fields');
  const htmlBodyFields = E('campaign-html-body-fields'), smsFields = E('campaign-sms-fields');

  [smsSender, emailSender, subjectFields, simpleBodyFields, htmlBodyFields, smsFields].forEach(el => el.classList.add('campaign-hidden'));

  if (type === 'sms') {
    smsSender.classList.remove('campaign-hidden');
    smsFields.classList.remove('campaign-hidden');
  } else {
    emailSender.classList.remove('campaign-hidden');
    subjectFields.classList.remove('campaign-hidden');
    if (type === 'simple-email') simpleBodyFields.classList.remove('campaign-hidden');
    if (type === 'html-email') htmlBodyFields.classList.remove('campaign-hidden');
  }
}

// Schedule toggle
function campaignToggleSchedule() {
  const sendNow = E('campaign-send-now').checked;
  E('campaign-schedule-field').classList.toggle('campaign-hidden', sendNow);
}

// Subject hint
function updateSubjectHint() {
  const len = E('campaign-email-subject').value.length;
  const hint = E('subject-hint');
  if (len < 10) { hint.textContent = `${len}/150 — too short`; hint.style.color='red'; }
  else if (len <= 60) { hint.textContent = `${len}/150 — good length`; hint.style.color='green'; }
  else if (len <= 90) { hint.textContent = `${len}/150 — may truncate on mobile`; hint.style.color='orange'; }
  else { hint.textContent = `${len}/150 — high risk of truncation`; hint.style.color='red'; }
}

// Schedule campaign
async function campaignScheduleCampaign() {
  try {
    const type = document.querySelector('input[name="campaign-type"]:checked')?.value;
    if (!type) throw new Error('Please select a campaign type.');

    let sender = '', subject = '', body = '';
    if (type === 'sms') {
      sender = E('campaign-sms-phone').value;
      if (!sender) throw new Error('Please select a phone number.');
      body = E('campaign-sms-body').value.trim();
      if (!body) throw new Error('Please fill in the SMS body.');
    } else {
      sender = E('campaign-email-address').value;
      if (!sender) throw new Error('Please select an email address.');
      subject = E('campaign-email-subject').value.trim();
      if (!subject) throw new Error('Please fill in the email subject.');
      if (type === 'simple-email') {
        body = quillBody.root.innerHTML;
        if (!quillBody.getText().trim()) throw new Error('Please fill in the email body.');
      } else {
        body = E('campaign-html-body').value.trim();
        if (!body) throw new Error('Please paste the HTML body.');
      }
    }

    const sendNow = E('campaign-send-now').checked;
    const schedule = sendNow ? new Date().toISOString() : E('campaign-schedule').value;
    if (!sendNow && !schedule) throw new Error('Please specify a schedule date/time or check "Send Now".');

    const selectedContacts = Array.from(document.querySelectorAll('#campaign-reports-table input[type="checkbox"]:checked'))
                                  .map(cb => cb.closest('tr').cells[1].querySelector('a').textContent);
    if (!selectedContacts.length) throw new Error('Please select at least one contact.');

    const campaignType = type === 'sms' ? 'sms' : (type === 'simple-email' ? 'email' : 'html-email');

    // Insert campaign into DB
    const insertQuery = `INSERT INTO campaigns (type, sender, subject, body, schedule, contact_ids)
                         VALUES ('${campaignType}', '${sender.replace(/'/g,"''")}', '${subject.replace(/'/g,"''")}', '${body.replace(/'/g,"''")}', '${schedule}', '${selectedContacts.join(",")}')`;
    const response = await p.sendQuery(insertQuery);
    const insertId = response.data.query1.insertId;
    if (!insertId) throw new Error('No insert ID returned');

    // Pabbly webhook
    const pabblyUrl = 'https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjcwNTZkMDYzMjA0MzU1MjZmNTUzYzUxM2Ei_pc';
    const pabblyResponse = await fetch(pabblyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        campaign_id: insertId,
        send_mode: sendNow ? 'now' : 'scheduled',
        scheduled_at: schedule,
        type: campaignType,
        sender,
        subject,
        body,
        contact_ids: selectedContacts.join(','),
        username: p.username,
        password: p.password
      })
    });
    if (!pabblyResponse.ok) throw new Error('Pabbly request failed');

    // Trigger immediately if sendNow
    if (sendNow) {
      const triggerResponse = await fetch('/campaigns/trigger', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: p.username, password: p.password, campaign_id: insertId })
      });
      if (!triggerResponse.ok) throw new Error('Immediate trigger failed');
      const triggerData = await triggerResponse.json();
      console.log('Campaign triggered immediately:', triggerData);
    }

    try { p.Toast.fire({ icon: 'success', title: 'Campaign created successfully!' }); } catch (_) {}

  } catch (err) {
    console.error('Campaign creation failed:', err);
    try { p.Toast.fire({ icon: 'error', title: err.message || 'Campaign created, but sending failed' }); } catch (_) {}
  }
}

// Scheduled campaigns
function campaignLoadScheduledCampaigns() {
  const table = E('campaign-scheduled-table');
  while (table.rows.length > 1) table.deleteRow(1);
  const q = `SELECT * FROM campaigns WHERE status='scheduled'`;
  p.sendQuery(q).then(resp => {
    const campaigns = resp.data.query1;
    if (!Array.isArray(campaigns) || !campaigns.length) {
      const row = table.insertRow(); row.insertCell().colSpan=5; row.cells[0].textContent='No scheduled campaigns'; return;
    }
    campaigns.forEach(c => {
      const row = table.insertRow();
      row.insertCell().textContent=c.campaign_id;
      row.insertCell().textContent=c.type;
      row.insertCell().textContent=c.subject||'-';
      row.insertCell().textContent=c.scheduled_time;
      const actionCell = row.insertCell();
      actionCell.innerHTML=`<button class="big-button" onclick="campaignDeleteCampaign('${c.campaign_id}')">Delete</button>`;
    });
  }).catch(err => { console.error(err); try { p.Toast.fire({ icon:'error', title:'Failed to load scheduled campaigns.' }); } catch(_){} });
}

// Delete campaign
function campaignDeleteCampaign(id) {
  p.sendQuery(`DELETE FROM campaigns WHERE campaign_id='${id}'`)
    .then(() => { try { p.Toast.fire({icon:'success',title:`Campaign ${id} deleted.`}); } catch(_){}; campaignLoadScheduledCampaigns(); })
    .catch(err => { console.error(err); try { p.Toast.fire({icon:'error',title:'Failed to delete campaign.'}); } catch(_){} });
}

// Load scheduled campaigns on tab open
document.querySelector('button[onclick="campaignShowTab(\'campaign-tab-scheduled\')"]')
        .addEventListener('click', campaignLoadScheduledCampaigns);
</script>

</body>
</html>
