<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campaigns</title>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
  <!--<link rel="stylesheet" type="text/css" href="style.css" />-->
  <style>
    body {
  font-family: Arial, Helvetica, sans-serif;
}
.active {
  background-color: #aaaaaa;
}
input, select, .input-ta, .input {
  width: 200px;
  box-sizing: border-box;
  padding: 10px;
  border: 1px solid #cccccc;
  border-radius: 3px;
}
.input-label {
  vertical-align: top;
  margin-top: 10px;
  font-weight: bold;
  margin-bottom: 5px;
  text-align: right;
  width: 150px;
  display: inline-block;
}
.big-button {
  display: inline-block;
  padding: 10px 20px;
  background-color: #007bff;
  color: #ffffff;
  text-decoration: none;
  border-radius: 3px;
  transition: background-color 0.3s ease;
  width: 170px;
}
.big-button:hover {
  background-color: #0056b3;
}
.logTable {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}
.logTable td, .logTable th {
  border: 1px solid #dddddd;
  padding: 8px;
}
.logTable th {
  background-color: #26abe2; /* or #04AA6D if preferred */
  color: white;
}
.logTable tr:nth-child(even) {
  background-color: #f2f2f2;
}
.logTable tr:hover {
  background-color: #dddddd;
}
/* Campaign-specific styles */
.campaign-tab-header {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}
.campaign-tab-button {
  padding: 10px 20px;
  background-color: #f2f2f2;
  border: 1px solid #cccccc;
  border-bottom: none;
  cursor: pointer;
  font-weight: bold;
}
.campaign-tab-button.active {
  background-color: #ffffff;
  border-bottom: 2px solid #007bff;
}
.campaign-tab-main {
  display: none;
  padding: 20px;
  border: 1px solid #cccccc;
  background-color: #ffffff;
}
.campaign-tab-main.active {
  display: block;
}
.campaign-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 800px;
}
.campaign-form .input-label {
  font-weight: bold;
}
.campaign-form input, .campaign-form textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #cccccc;
  border-radius: 3px;
  box-sizing: border-box;
}
.campaign-form .radio-group {
  display: flex;
  gap: 20px;
}
.campaign-form .schedule-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.campaign-hidden {
  display: none;
}
    .quill-editor .ql-container {
      border: 1px solid #cccccc;
      border-radius: 3px;
      box-sizing: border-box;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
    }
    #campaign-email-subject-editor .ql-container {
      height: 20px;
      padding: 8px;
    }
    #campaign-email-body-editor .ql-container {
      height: 100px;
      padding: 8px;
    }
    .quill-editor .ql-toolbar {
      border: 1px solid #cccccc;
      border-bottom: none;
      border-radius: 3px 3px 0 0;
      background-color: #f2f2f2;
    }
  </style>
</head>
<body style="text-align: center">
  <h2>Campaigns</h2>
  <div id="campaign-container">
    <!-- Tab Header -->
    <div class="campaign-tab-header">
      <button class="campaign-tab-button active" onclick="campaignShowTab('campaign-tab-reports')">Select Contacts</button>
      <button class="campaign-tab-button" onclick="campaignShowTab('campaign-tab-compose')">Compose Campaign</button>
      <button class="campaign-tab-button" onclick="campaignShowTab('campaign-tab-scheduled')">Scheduled Campaigns</button>
    </div>
    <!-- Tab: Select Contacts -->
    <div id="campaign-tab-reports" class="campaign-tab-main active">
      <div class="input-label">Required Tags (all):</div>
      <input placeholder="tags separated by comma" id="campaign-report-required-tags" class="input">
      <div class="input-label">Any Tags (at least one):</div>
      <input placeholder="tags separated by comma" id="campaign-report-any-tags" class="input">
      <div class="input-label">Exclude Tags (none):</div>
      <input placeholder="tags separated by comma" id="campaign-report-exclude-tags" class="input">
      <button id="campaign-report-button" class="big-button" onclick="campaignGetForReport()">Get Contacts</button>
      <table id="campaign-reports-table" class="logTable">
        <tr>
          <th>Select</th>
          <th>ID</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
        </tr>
      </table>
    </div>
    <!-- Tab: Compose Campaign -->
    <div id="campaign-tab-compose" class="campaign-tab-main">
      <div class="campaign-form">
        <div class="radio-group">
          <label><input type="radio" name="campaign-type" value="sms" onchange="campaignToggleFields()"> SMS</label>
          <label><input type="radio" name="campaign-type" value="simple-email" checked onchange="campaignToggleFields()"> Simple Email</label>
          <label><input type="radio" name="campaign-type" value="html-email" onchange="campaignToggleFields()"> HTML Email</label>
        </div>
        <div id="campaign-subject-fields">
          <div class="input-label">Email Subject:</div>
          <div id="campaign-email-subject-editor" class="quill-editor"></div>
        </div>
        <div id="campaign-simple-body-fields">
          <div class="input-label">Email Body:</div>
          <div id="campaign-email-body-editor" class="quill-editor"></div>
        </div>
        <div id="campaign-html-body-fields" class="campaign-hidden">
          <div class="input-label">HTML Body:</div>
          <textarea id="campaign-html-body" class="input-ta" rows="10" placeholder="Paste HTML here"></textarea>
        </div>
        <div id="campaign-sms-fields" class="campaign-hidden">
          <div class="input-label">SMS Body:</div>
          <textarea id="campaign-sms-body" class="input-ta" rows="3" placeholder="Enter SMS body (max 160 characters)" maxlength="160"></textarea>
        </div>
        <div class="schedule-group">
          <label><input type="checkbox" id="campaign-send-now" checked onchange="campaignToggleSchedule()"> Send Now</label>
          <div id="campaign-schedule-field" class="campaign-hidden">
            <span class="input-label">Or Schedule:</span>
            <input type="datetime-local" id="campaign-schedule" class="input">
          </div>
        </div>
        <button class="big-button" onclick="campaignScheduleCampaign()">Create Campaign</button>
      </div>
    </div>
    <!-- Tab: Scheduled Campaigns -->
    <div id="campaign-tab-scheduled" class="campaign-tab-main">
      <table id="campaign-scheduled-table" class="logTable">
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Subject</th>
          <th>Scheduled Time</th>
          <th>Action</th>
        </tr>
      </table>
    </div>
  </div>
  <script>
    // Shorthand for local document.getElementById
    const E = (id) => document.getElementById(id);
    // Shorthand for window.parent
    const p = window.parent;
    // Initialize Quill editors
    let quillSubject = null;
    let quillBody = null;
    document.addEventListener('DOMContentLoaded', () => {
      quillSubject = new Quill('#campaign-email-subject-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link']
          ]
        },
        placeholder: 'Enter email subject'
      });
      quillBody = new Quill('#campaign-email-body-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link', 'image']
          ]
        },
        placeholder: 'Enter email body'
      });
      // Set initial field visibility
      campaignToggleFields();
      campaignToggleSchedule();
    });
    // Tab switching function
    function campaignShowTab(tabId) {
      document.querySelectorAll('.campaign-tab-button').forEach(button => {
        button.classList.remove('active');
      });
      document.querySelectorAll('.campaign-tab-main').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`button[onclick="campaignShowTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }
    // Toggle fields based on selected type
    function campaignToggleFields() {
      const type = document.querySelector('input[name="campaign-type"]:checked')?.value || 'simple-email';
      const subjectFields = E('campaign-subject-fields');
      const simpleBodyFields = E('campaign-simple-body-fields');
      const htmlBodyFields = E('campaign-html-body-fields');
      const smsFields = E('campaign-sms-fields');
      if (type === 'sms') {
        subjectFields.classList.add('campaign-hidden');
        simpleBodyFields.classList.add('campaign-hidden');
        htmlBodyFields.classList.add('campaign-hidden');
        smsFields.classList.remove('campaign-hidden');
      } else if (type === 'simple-email') {
        subjectFields.classList.remove('campaign-hidden');
        simpleBodyFields.classList.remove('campaign-hidden');
        htmlBodyFields.classList.add('campaign-hidden');
        smsFields.classList.add('campaign-hidden');
      } else if (type === 'html-email') {
        subjectFields.classList.remove('campaign-hidden');
        simpleBodyFields.classList.add('campaign-hidden');
        htmlBodyFields.classList.remove('campaign-hidden');
        smsFields.classList.add('campaign-hidden');
      }
    }
    // Toggle schedule field based on Send Now checkbox
    function campaignToggleSchedule() {
      const sendNow = E('campaign-send-now').checked;
      const scheduleField = E('campaign-schedule-field');
      scheduleField.classList.toggle('campaign-hidden', sendNow);
    }
    // Fetch contacts for report
    function campaignGetForReport() {
      const requiredInput = E('campaign-report-required-tags').value;
      const anyInput = E('campaign-report-any-tags').value;
      const excludeInput = E('campaign-report-exclude-tags').value;
      const required = requiredInput.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      const any = anyInput.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      const exclude = excludeInput.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      if (required.length === 0 && any.length === 0) {
        console.error('No valid include tags provided');
        p.Toast.fire({ icon: 'error', title: 'Please enter at least one tag in Required or Any fields.' });
        return;
      }
      const makeLike = (tag) => {
        const safeTag = tag.replace(/'/g, "''");
        return `(contact_tags = '${safeTag}' OR contact_tags LIKE '${safeTag},%' OR contact_tags LIKE '%,${safeTag},%' OR contact_tags LIKE '%,${safeTag}')`;
      };
      let whereParts = [];
      if (required.length > 0) {
        whereParts.push(required.map(makeLike).join(' AND '));
      }
      if (any.length > 0) {
        whereParts.push('(' + any.map(makeLike).join(' OR ') + ')');
      }
      if (exclude.length > 0) {
        whereParts.push('NOT (' + exclude.map(makeLike).join(' OR ') + ')');
      }
      const whereClause = whereParts.join(' AND ');
      const q = `SELECT * FROM contacts WHERE ${whereClause}`;
      console.log('Executing query:', q);
      const table = E('campaign-reports-table');
      while (table.rows.length > 1) {
        table.deleteRow(1);
      }
      p.sendQuery(q)
        .then(response => {
          const results = response.data.query1;
          if (!Array.isArray(results) || results.length === 0) {
            console.warn('No results found for the query');
            const row = table.insertRow();
            const cell = row.insertCell();
            cell.textContent = 'No results found';
            cell.colSpan = 5;
            return;
          }
          results.forEach((contact, index) => {
            const row = table.insertRow();
            const checkboxCell = row.insertCell();
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = true;
            checkbox.id = `campaign-contact-checkbox-${index}`;
            checkboxCell.appendChild(checkbox);
            const fields = ['contact_id', 'contact_name', 'contact_phone', 'contact_email', 'contact_tags'];
            fields.forEach((field, fieldIndex) => {
              const cell = row.insertCell();
              if (field === 'contact_id') {
                const escapedName = contact.contact_name ? contact.contact_name.replace(/'/g, "\\'") : '';
                cell.innerHTML = `<a href="#" onclick="window.parent.addFile('${escapedName}', 'contact', '${contact.contact_id}')">${contact.contact_id}</a>`;
              } else {
                cell.textContent = contact[field] || '-';
              }
            });
          });
        })
        .catch(error => {
          console.error('Query failed:', error);
          p.Toast.fire({ icon: 'error', title: 'An error occurred while fetching the report. Please try again.' });
        });
    }
    // Schedule a campaign
    function campaignScheduleCampaign() {
      const type = document.querySelector('input[name="campaign-type"]:checked')?.value;
      if (!type) {
        p.Toast.fire({ icon: 'error', title: 'Please select a campaign type.' });
        return;
      }
      let subject = '';
      let body = '';
      if (type === 'sms') {
        body = E('campaign-sms-body').value;
        if (!body.trim()) {
          p.Toast.fire({ icon: 'error', title: 'Please fill in the SMS body.' });
          return;
        }
      } else {
        subject = quillSubject.root.innerHTML;
        if (!quillSubject.getText().trim()) {
          p.Toast.fire({ icon: 'error', title: 'Please fill in the email subject.' });
          return;
        }
        if (type === 'simple-email') {
          body = quillBody.root.innerHTML;
          if (!quillBody.getText().trim()) {
            p.Toast.fire({ icon: 'error', title: 'Please fill in the email body.' });
            return;
          }
        } else { // html-email
          body = E('campaign-html-body').value;
          if (!body.trim()) {
            p.Toast.fire({ icon: 'error', title: 'Please paste the HTML body.' });
            return;
          }
        }
      }
      const sendNow = E('campaign-send-now').checked;
      const schedule = sendNow ? new Date().toISOString() : E('campaign-schedule').value;
      if (!sendNow && !schedule) {
        p.Toast.fire({ icon: 'error', title: 'Please specify a schedule date/time or check "Send Now".' });
        return;
      }
      const selectedContacts = Array.from(document.querySelectorAll('#campaign-reports-table input[type="checkbox"]:checked'))
        .map(checkbox => {
          const row = checkbox.closest('tr');
          const contactIdCell = row.cells[1].querySelector('a');
          return contactIdCell.textContent;
        });
      if (selectedContacts.length === 0) {
        p.Toast.fire({ icon: 'error', title: 'Please select at least one contact.' });
        return;
      }
      // Send query
      const campaignType = type === 'sms' ? 'sms' : 'email';
      const q = `INSERT INTO campaigns (type, subject, body, schedule, contact_ids) VALUES ('${campaignType}', '${subject.replace(/'/g, "''")}', '${body.replace(/'/g, "''")}', '${schedule}', '${selectedContacts.join(',')}')`;
      console.log('Scheduling campaign with query:', q);
      p.sendQuery(q)
        .then(response => {
          p.Toast.fire({ icon: 'success', title: 'Campaign created successfully!' });
        })
        .catch(error => {
          console.error('Failed to create campaign:', error);
          p.Toast.fire({ icon: 'error', title: 'Failed to create campaign. Please try again.' });
        });
    }
    // Fetch scheduled campaigns
    function campaignLoadScheduledCampaigns() {
      const table = E('campaign-scheduled-table');
      while (table.rows.length > 1) {
        table.deleteRow(1);
      }
      const q = `SELECT campaign_id, type, subject, scheduled_time FROM campaigns WHERE status = 'scheduled'`;
      console.log('Fetching scheduled campaigns with query:', q);
      p.sendQuery(q)
        .then(response => {
          const campaigns = response.data.query1;
          if (!Array.isArray(campaigns) || campaigns.length === 0) {
            const row = table.insertRow();
            const cell = row.insertCell();
            cell.textContent = 'No scheduled campaigns';
            cell.colSpan = 5;
            return;
          }
          campaigns.forEach(campaign => {
            const row = table.insertRow();
            row.insertCell().textContent = campaign.campaign_id;
            row.insertCell().textContent = campaign.type;
            row.insertCell().textContent = campaign.subject || '-';
            row.insertCell().textContent = campaign.scheduled_time;
            const actionCell = row.insertCell();
            actionCell.innerHTML = `<button class="big-button" onclick="campaignDeleteCampaign('${campaign.campaign_id}')">Delete</button>`;
          });
        })
        .catch(error => {
          console.error('Failed to load scheduled campaigns:', error);
          p.Toast.fire({ icon: 'error', title: 'Failed to load scheduled campaigns.' });
        });
    }
    // Delete a campaign
    function campaignDeleteCampaign(campaignId) {
      const q = `DELETE FROM campaigns WHERE campaign_id = '${campaignId}'`;
      console.log('Deleting campaign with query:', q);
      p.sendQuery(q)
        .then(response => {
          p.Toast.fire({ icon: 'success', title: `Campaign ${campaignId} deleted.` });
          campaignLoadScheduledCampaigns();
        })
        .catch(error => {
          console.error('Failed to delete campaign:', error);
          p.Toast.fire({ icon: 'error', title: 'Failed to delete campaign.' });
        });
    }
    // Load scheduled campaigns when the tab is opened
    document.querySelector('button[onclick="campaignShowTab(\'campaign-tab-scheduled\')"]').addEventListener('click', campaignLoadScheduledCampaigns);
  </script>
</body>
</html>
