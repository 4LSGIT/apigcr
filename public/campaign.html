<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campaigns</title>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
  <!--<link rel="stylesheet" type="text/css" href="style.css" />-->
  <style>
    body {
  font-family: Arial, Helvetica, sans-serif;
}
.active {
  background-color: #aaaaaa;
}
input, select, .input-ta, .input {
  width: 200px;
  box-sizing: border-box;
  padding: 10px;
  border: 1px solid #cccccc;
  border-radius: 3px;
}
.input-label {
  vertical-align: top;
  margin-top: 10px;
  font-weight: bold;
  margin-bottom: 5px;
  text-align: right;
  width: 150px;
  display: inline-block;
}
.big-button {
  display: inline-block;
  padding: 10px 20px;
  background-color: #007bff;
  color: #ffffff;
  text-decoration: none;
  border-radius: 3px;
  transition: background-color 0.3s ease;
  width: 170px;
}
.big-button:hover {
  background-color: #0056b3;
}
.logTable {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}
.logTable td, .logTable th {
  border: 1px solid #dddddd;
  padding: 8px;
}
.logTable th {
  background-color: #26abe2; /* or #04AA6D if preferred */
  color: white;
}
.logTable tr:nth-child(even) {
  background-color: #f2f2f2;
}
.logTable tr:hover {
  background-color: #dddddd;
}
/* Campaign-specific styles */
.campaign-tab-header {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}
.campaign-tab-button {
  padding: 10px 20px;
  background-color: #f2f2f2;
  border: 1px solid #cccccc;
  border-bottom: none;
  cursor: pointer;
  font-weight: bold;
}
.campaign-tab-button.active {
  background-color: #ffffff;
  border-bottom: 2px solid #007bff;
}
.campaign-tab-main {
  display: none;
  padding: 20px;
  border: 1px solid #cccccc;
  background-color: #ffffff;
}
.campaign-tab-main.active {
  display: block;
}
.campaign-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 800px;
}
.campaign-form .input-label {
  font-weight: bold;
}
.campaign-form input, .campaign-form textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #cccccc;
  border-radius: 3px;
  box-sizing: border-box;
}
.campaign-form .radio-group {
  display: flex;
  gap: 20px;
}
.campaign-form .schedule-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.campaign-hidden {
  display: none;
}
    .quill-editor .ql-container {
      border: 1px solid #cccccc;
      border-radius: 3px;
      box-sizing: border-box;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
    }
    #campaign-email-subject-editor .ql-container {
      height: 20px;
      padding: 8px;
    }
    #campaign-email-body-editor .ql-container {
      height: 300px;
      padding: 8px;
    }
    .quill-editor .ql-toolbar {
      border: 1px solid #cccccc;
      border-bottom: none;
      border-radius: 3px 3px 0 0;
      background-color: #f2f2f2;
    }
    #subject-hint {
      font-size: 12px;
      margin-top: 4px;
      text-align: left;
    }
    .small-insert-btn {
      padding: 4px 10px;
      font-size: 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .small-insert-btn:hover {
      background: #5a6268;
    }
    .campaign-action-btn {
      padding: 5px 10px;
      margin-right: 5px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .campaign-action-btn:hover {
      background-color: #218838;
    }
    .campaign-action-btn.delete {
      background-color: #dc3545;
    }
    .campaign-action-btn.delete:hover {
      background-color: #c82333;
    }
    #campaign-stats-modal, #campaign-details-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 600px;
      z-index: 1000;
      overflow: auto;
    }
    #campaign-stats-modal.active, #campaign-details-modal.active {
      display: block;
    }
    #stats-close-btn, #details-close-btn {
      float: right;
      cursor: pointer;
    }
    #campaign-view-filters {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body style="text-align: center">
  <h2>Campaigns</h2>
  <div id="campaign-container">
    <!-- Tab Header -->
    <div class="campaign-tab-header">
      <button class="campaign-tab-button active" onclick="campaignShowTab('campaign-tab-reports')">Select Contacts</button>
      <button class="campaign-tab-button" onclick="campaignShowTab('campaign-tab-compose')">Compose Campaign</button>
      <button class="campaign-tab-button" onclick="campaignShowTab('campaign-tab-view')">View Campaigns</button>
    </div>
    <!-- Tab: Select Contacts -->
    <div id="campaign-tab-reports" class="campaign-tab-main active">
      <div class="input-label">Required Tags (all):</div>
      <input placeholder="tags separated by comma" id="campaign-report-required-tags" class="input">
      <div class="input-label">Any Tags (at least one):</div>
      <input placeholder="tags separated by comma" id="campaign-report-any-tags" class="input">
      <div class="input-label">Exclude Tags (none):</div>
      <input placeholder="tags separated by comma" id="campaign-report-exclude-tags" class="input">
      <button id="campaign-report-button" class="big-button" onclick="campaignGetForReport()">Get Contacts</button>
      <table id="campaign-reports-table" class="logTable">
        <tr>
          <th>Select</th>
          <th>ID</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Tags</th>
        </tr>
      </table>
    </div>
    <!-- Tab: Compose Campaign -->
    <div id="campaign-tab-compose" class="campaign-tab-main">
      <div class="campaign-form">
        <div class="radio-group">
          <label><input type="radio" name="campaign-type" value="sms" onchange="campaignToggleFields()"> SMS</label>
          <label><input type="radio" name="campaign-type" value="simple-email" checked onchange="campaignToggleFields()"> Simple Email</label>
          <label><input type="radio" name="campaign-type" value="html-email" onchange="campaignToggleFields()"> HTML Email</label>
        </div>
        <div class="personalization-help" style="margin:10px 0; font-size:13px; color:#555; text-align:left;">
          <label>Personalize: </label>
          <select id="placeholder-selector" class="input" style="width:auto;">
            <option value="">— Select field —</option>
            <option value="contact_fname">First Name</option>
            <option value="contact_lname">Last Name</option>
            <option value="contact_name">Full Name</option>
            <option value="contact_lfm_name">Name (Last, First Middle)</option>
            <option value="contact_phone">Phone</option>
            <option value="contact_email">Email</option>
            <option value="contact_id">Contact ID</option>
            <option value="contact_address">Address</option>
            <option value="contact_city">City</option>
            <option value="contact_state">State</option>
            <option value="contact_zip">Zip</option>
            <option value="contact_dob||date:MMMM Do, YYYY">Birthday (formatted)</option>
            <option value="contact_dob||date:YYYY-MM-DD">Birthday (YYYY-MM-DD)</option>
            <!-- Add more hardcoded as needed -->
          </select>
          <button type="button" class="small-insert-btn" onclick="insertSelectedPlaceholder()">Insert</button>
        </div>
        <div id="campaign-sender-fields">
          <div id="campaign-sms-sender" class="campaign-hidden">
            <div class="input-label">From Phone:</div>
            <select id="campaign-sms-phone" class="input">
              <option value="">Select phone number</option>
              <!-- Populate options dynamically or statically as needed -->
              <option value="+12485592400">+1 (248) 559-2400</option>
              <option value="+12486213656">+1 (248) 621-3656</option>
              <option value="+12345678910">+1 (234) 567-8910 - fail</option>
            </select>
          </div>
          <div id="campaign-email-sender" class="campaign-hidden">
            <div class="input-label">From Email:</div>
            <select id="campaign-email-address" class="input">
              <option value="">Select email address</option>
              <!-- Populate options dynamically or statically as needed -->
              <option value="shoshana@metrodetroitbankruptcylaw.com">shoshana@metrodetroitbankruptcylaw.com</option>
              <option value="support@example.com">support@example.com - fail</option>
            </select>
          </div>
        </div>
        <div id="campaign-subject-fields" class="campaign-hidden">
          <div class="input-label">Email Subject:</div>
          <div style="display:flex; justify-content:center; gap:6px;">
            <input
              id="campaign-email-subject"
              type="text"
              maxlength="150"
              placeholder="Enter subject"
            >
          </div>
          <div id="subject-hint"></div>
        </div>
        <div id="campaign-simple-body-fields" class="campaign-hidden">
          <div class="input-label">Email Body:</div>
          <div id="campaign-email-body-editor" class="quill-editor"></div>
        </div>
        <div id="campaign-html-body-fields" class="campaign-hidden">
          <div class="input-label">HTML Body:</div>
          <textarea id="campaign-html-body" class="input-ta" rows="10" placeholder="Paste HTML here"></textarea>
        </div>
        <div id="campaign-sms-fields" class="campaign-hidden">
          <div class="input-label">SMS Body:</div>
          <textarea id="campaign-sms-body" class="input-ta" rows="3" placeholder="Enter SMS body (max 160 characters)" maxlength="160"></textarea>
        </div>
        <div class="schedule-group">
          <label><input type="checkbox" id="campaign-send-now" checked onchange="campaignToggleSchedule()"> Send Now</label>
          <div id="campaign-schedule-field" class="campaign-hidden">
            <span class="input-label">Or Schedule:</span>
            <input type="datetime-local" id="campaign-schedule" class="input">
          </div>
        </div>
        <button class="big-button" onclick="campaignScheduleCampaign()">Create Campaign</button>
      </div>
    </div>
    <!-- Tab: View Campaigns -->
    <div id="campaign-tab-view" class="campaign-tab-main">
      <div id="campaign-view-filters">
        <label>Status: </label>
        <select id="filter-status" onchange="campaignLoadViewCampaigns()">
          <option value="all">All</option>
          <option value="scheduled">Scheduled</option>
          <option value="sending">Sending</option>
          <option value="sent">Sent</option>
          <option value="failed">Failed</option>
          <option value="partial fail">Partial Fail</option>
          <option value="canceled">Canceled</option>
        </select>
        <label>Order: </label>
        <select id="filter-order" onchange="campaignLoadViewCampaigns()">
          <option value="DESC">Newest First</option>
          <option value="ASC">Oldest First</option>
        </select>
      </div>
      <table id="campaign-view-table" class="logTable">
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Subject</th>
          <th>Schedule</th>
          <th>Status</th>
          <th>Created By</th>
          <th>Contacts</th>
          <th>Actions</th>
        </tr>
      </table>
    </div>
  </div>
  <!-- Modal for Campaign Stats -->
  <div id="campaign-stats-modal">
    <span id="stats-close-btn" onclick="closeStatsModal()">&times;</span>
    <h3>Campaign Stats for ID: <span id="stats-campaign-id"></span></h3>
    <p>Total Contacts: <span id="stats-total"></span></p>
    <p>Sent: <span id="stats-sent"></span></p>
    <p>Failed: <span id="stats-failed"></span></p>
    <table id="stats-results-table" class="logTable">
      <tr>
        <th>Contact ID</th>
        <th>Status</th>
        <th>Error</th>
      </tr>
    </table>
  </div>
  <!-- Modal for Campaign Details -->
  <div id="campaign-details-modal">
    <span id="details-close-btn" onclick="closeDetailsModal()">&times;</span>
    <h3>Campaign Details for ID: <span id="details-campaign-id"></span></h3>
    <p>Type: <span id="details-type"></span></p>
    <p>Sender: <span id="details-sender"></span></p>
    <p>Subject: <span id="details-subject"></span></p>
    <p>Body:</p>
    <div id="details-body" style="border:1px solid #ccc; padding:10px; max-height:300px; overflow:auto;"></div>
    <p>Contacts:</p>
    <table id="details-contacts-table" class="logTable">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
      </tr>
    </table>
  </div>
 <script>
const E = (id) => document.getElementById(id);
const p = window.parent;
let quillBody = null;
let lastFocusedElement = null;
document.addEventListener('DOMContentLoaded', () => {
  quillBody = new Quill('#campaign-email-body-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link', 'image']
      ]
    },
    placeholder: 'Enter email body'
  });
  // Custom image uploader handler
  const toolbar = quillBody.getModule('toolbar');
  toolbar.addHandler('image', function(value) {
    if (value) {
      const quill = this.quill;
      const range = quill.getSelection();
      const input = document.createElement('input');
      input.setAttribute('type', 'file');
      input.setAttribute('accept', 'image/*');
      input.click();
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('username', p.username);
        formData.append('password', p.password);
        try {
          const response = await fetch('/upload', {
            method: 'POST',
            body: formData
          });
          if (!response.ok) throw new Error('Upload failed');
          const data = await response.json();
          if (!data.success) throw new Error('Upload not successful');
          const url = data.url;
          quill.insertEmbed(range.index, 'image', url);
          quill.setSelection(range.index + 1);
        } catch (err) {
          console.error('Image upload error:', err);
          try { p.Toast.fire({ icon: 'error', title: 'Failed to upload image.' }); } catch (_) {}
        }
      };
    } else {
      this.quill.format('image', false);
    }
  });
  // Track last focused editable element
  const editableFields = [
    E('campaign-email-subject'),
    E('campaign-html-body'),
    E('campaign-sms-body'),
    document.querySelector('#campaign-email-body-editor .ql-editor') // For Quill
  ].filter(el => el); // Filter out nulls if any
  editableFields.forEach(field => {
    field.addEventListener('focus', () => {
      lastFocusedElement = field;
    });
  });
  campaignToggleFields();
  campaignToggleSchedule();
  E('campaign-email-subject').addEventListener('input', updateSubjectHint);
  updateSubjectHint();
});
async function campaignGetForReport() {
  const requiredInput = E('campaign-report-required-tags').value;
  const anyInput = E('campaign-report-any-tags').value;
  const excludeInput = E('campaign-report-exclude-tags').value;
  const required = requiredInput.split(',').map(t => t.trim()).filter(t => t);
  const any = anyInput.split(',').map(t => t.trim()).filter(t => t);
  const exclude = excludeInput.split(',').map(t => t.trim()).filter(t => t);
  if (!required.length && !any.length) {
    try { p.Toast.fire({ icon: 'error', title: 'Please enter at least one tag in Required or Any fields.' }); } catch (_) {}
    return;
  }
  const makeLike = tag => `(contact_tags='${tag.replace(/'/g,"''")}' OR contact_tags LIKE '${tag},%' OR contact_tags LIKE '%,${tag},%' OR contact_tags LIKE '%,${tag}')`;
  const whereParts = [];
  if (required.length) whereParts.push(required.map(makeLike).join(' AND '));
  if (any.length) whereParts.push('(' + any.map(makeLike).join(' OR ') + ')');
  if (exclude.length) whereParts.push('NOT (' + exclude.map(makeLike).join(' OR ') + ')');
  const query = `SELECT * FROM contacts WHERE ${whereParts.join(' AND ')}`;
  console.log('Executing query:', query);
  const table = E('campaign-reports-table');
  while (table.rows.length > 1) table.deleteRow(1);
  try {
    const response = await p.sendQuery(query);
    const results = response.data.query1;
    if (!Array.isArray(results) || !results.length) {
      const row = table.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 5;
      cell.textContent = 'No results found';
      return;
    }
    results.forEach((contact, index) => {
      const row = table.insertRow();
      const checkboxCell = row.insertCell();
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = true;
      checkbox.id = `campaign-contact-checkbox-${index}`;
      checkboxCell.appendChild(checkbox);
      ['contact_id', 'contact_name', 'contact_phone', 'contact_email', 'contact_tags'].forEach(field => {
        const cell = row.insertCell();
        if (field === 'contact_id') {
          const escapedName = contact.contact_name ? contact.contact_name.replace(/'/g,"\\'") : '';
          cell.innerHTML = `<a href="#" onclick="window.parent.addFile('${escapedName}','contact','${contact.contact_id}')">${contact.contact_id}</a>`;
        } else {
          cell.textContent = contact[field] || '-';
        }
      });
    });
  } catch (err) {
    console.error('Failed to fetch report:', err);
    try { p.Toast.fire({ icon: 'error', title: 'Error fetching report.' }); } catch (_) {}
  }
}
// Tab switching
function campaignShowTab(tabId) {
  document.querySelectorAll('.campaign-tab-button').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.campaign-tab-main').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`button[onclick="campaignShowTab('${tabId}')"]`).classList.add('active');
  E(tabId).classList.add('active');
}
// Field toggling
function campaignToggleFields() {
  const type = document.querySelector('input[name="campaign-type"]:checked')?.value || 'simple-email';
  const smsSender = E('campaign-sms-sender'), emailSender = E('campaign-email-sender');
  const subjectFields = E('campaign-subject-fields'), simpleBodyFields = E('campaign-simple-body-fields');
  const htmlBodyFields = E('campaign-html-body-fields'), smsFields = E('campaign-sms-fields');
  [smsSender, emailSender, subjectFields, simpleBodyFields, htmlBodyFields, smsFields].forEach(el => el.classList.add('campaign-hidden'));
  if (type === 'sms') {
    smsSender.classList.remove('campaign-hidden');
    smsFields.classList.remove('campaign-hidden');
  } else {
    emailSender.classList.remove('campaign-hidden');
    subjectFields.classList.remove('campaign-hidden');
    if (type === 'simple-email') simpleBodyFields.classList.remove('campaign-hidden');
    if (type === 'html-email') htmlBodyFields.classList.remove('campaign-hidden');
  }
}
// Schedule toggle
function campaignToggleSchedule() {
  const sendNow = E('campaign-send-now').checked;
  E('campaign-schedule-field').classList.toggle('campaign-hidden', sendNow);
}
// Subject hint
function updateSubjectHint() {
  const len = E('campaign-email-subject').value.length;
  const hint = E('subject-hint');
  if (len < 10) { hint.textContent = `${len}/150 — too short`; hint.style.color='red'; }
  else if (len <= 60) { hint.textContent = `${len}/150 — good length`; hint.style.color='green'; }
  else if (len <= 90) { hint.textContent = `${len}/150 — may truncate on mobile`; hint.style.color='orange'; }
  else { hint.textContent = `${len}/150 — high risk of truncation`; hint.style.color='red'; }
}
// Schedule campaign
async function campaignScheduleCampaign() {
  try {
    const type = document.querySelector('input[name="campaign-type"]:checked')?.value;
    if (!type) throw new Error('Please select a campaign type.');
    let sender = '', subject = '', body = '';
    if (type === 'sms') {
      sender = E('campaign-sms-phone').value;
      if (!sender) throw new Error('Please select a phone number.');
      body = E('campaign-sms-body').value.trim();
      if (!body) throw new Error('Please fill in the SMS body.');
    } else {
      sender = E('campaign-email-address').value;
      if (!sender) throw new Error('Please select an email address.');
      subject = E('campaign-email-subject').value.trim();
      if (!subject) throw new Error('Please fill in the email subject.');
      if (type === 'simple-email') {
        body = quillBody.root.innerHTML;
        if (!quillBody.getText().trim()) throw new Error('Please fill in the email body.');
      } else {
        body = E('campaign-html-body').value.trim();
        if (!body) throw new Error('Please paste the HTML body.');
      }
    }
    const sendNow = E('campaign-send-now').checked;
    const schedule = sendNow ? new Date().toISOString() : E('campaign-schedule').value;
    if (!sendNow && !schedule) throw new Error('Please specify a schedule date/time or check "Send Now".');
    const selectedContacts = Array.from(document.querySelectorAll('#campaign-reports-table input[type="checkbox"]:checked'))
                                  .map(cb => cb.closest('tr').cells[1].querySelector('a').textContent);
    if (!selectedContacts.length) throw new Error('Please select at least one contact.');
    const campaignType = type === 'sms' ? 'sms' : (type === 'simple-email' ? 'email' : 'html-email');
    const userId = p.user?.user ?? null; // Use nullish coalescing → null if undefined/missing
    // Insert campaign into DB
    const insertQuery = `INSERT INTO campaigns (type, sender, subject, body, schedule, contact_ids, created_by)
                         VALUES ('${campaignType}', '${sender.replace(/'/g,"''")}', '${subject.replace(/'/g,"''")}', '${body.replace(/'/g,"''")}', '${schedule}', '${selectedContacts.join(",")}', ${userId !== null ? userId : 'NULL'})`;
    const response = await p.sendQuery(insertQuery);
    const insertId = response.data.query1.insertId;
    if (!insertId) throw new Error('No insert ID returned');
    // Pabbly webhook
    const pabblyUrl = 'https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjcwNTZkMDYzMjA0MzU1MjZmNTUzYzUxM2Ei_pc';
    const pabblyResponse = await fetch(pabblyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        campaign_id: insertId,
        send_mode: sendNow ? 'now' : 'scheduled',
        scheduled_at: schedule,
        type: campaignType,
        sender,
        subject,
        body,
        contact_ids: selectedContacts.join(','),
        username: p.username,
        password: p.password
      })
    });
    if (!pabblyResponse.ok) throw new Error('Pabbly request failed');
    // Trigger immediately if sendNow
    if (sendNow) {
      const triggerResponse = await fetch('/campaigns/trigger', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: p.username, password: p.password, campaign_id: insertId })
      });
      if (!triggerResponse.ok) throw new Error('Immediate trigger failed');
      const triggerData = await triggerResponse.json();
      console.log('Campaign triggered immediately:', triggerData);
    }
    try { p.Toast.fire({ icon: 'success', title: 'Campaign created successfully!' }); } catch (_) {}
  } catch (err) {
    console.error('Campaign creation failed:', err);
    try { p.Toast.fire({ icon: 'error', title: err.message || 'Campaign created, but sending failed' }); } catch (_) {}
  }
}
// View campaigns (formerly scheduled)
async function campaignLoadViewCampaigns() {
  const table = E('campaign-view-table');
  while (table.rows.length > 1) table.deleteRow(1);
  const statusFilter = E('filter-status').value;
  const order = E('filter-order').value;
  let where = '';
  if (statusFilter !== 'all') where = `WHERE status='${statusFilter}'`;
  const q = `SELECT c.*, u.user_name AS created_by_name, LENGTH(contact_ids) - LENGTH(REPLACE(contact_ids, ',', '')) + 1 AS contact_count
             FROM campaigns c LEFT JOIN users u ON c.created_by = u.user ${where} ORDER BY schedule ${order}`;
  try {
    const resp = await p.sendQuery(q);
    const campaigns = resp.data.query1;
    if (!Array.isArray(campaigns) || !campaigns.length) {
      const row = table.insertRow(); 
      row.insertCell().colSpan=8; 
      row.cells[0].textContent='No campaigns found'; 
      return;
    }
    campaigns.forEach(c => {
      const row = table.insertRow();
      row.insertCell().textContent = c.campaign_id;
      row.insertCell().textContent = c.type;
      row.insertCell().textContent = c.subject || '-';
//      row.insertCell().textContent = c.schedule;
      row.insertCell().textContent = c.schedule ? new Date(c.schedule).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : '-';
      row.insertCell().textContent = c.status || 'unknown';
      row.insertCell().textContent = c.created_by_name || 'Unknown';
      row.insertCell().textContent = c.contact_count || 0;
      const actionCell = row.insertCell();
      let actions = `<button class="campaign-action-btn" onclick="viewCampaignDetails('${c.campaign_id}')">View Details</button>
                     <button class="campaign-action-btn" onclick="duplicateCampaign('${c.campaign_id}')">Duplicate</button>`;
      if (['processed', 'sent', 'failed', 'partial fail'].includes(c.status)) {
        actions += ` <button class="campaign-action-btn" onclick="viewCampaignStats('${c.campaign_id}')">View Stats</button>`;
      }
      if (c.status === 'scheduled') {
        actions += ` <button class="campaign-action-btn delete" onclick="cancelCampaign('${c.campaign_id}')">Cancel</button>`;
      }
      actionCell.innerHTML = actions;
    });
  } catch (err) {
    console.error(err); 
    try { p.Toast.fire({ icon:'error', title:'Failed to load campaigns.' }); } catch(_){} 
  }
}
// Load view campaigns on tab open
document.querySelector('button[onclick="campaignShowTab(\'campaign-tab-view\')"]')
        .addEventListener('click', campaignLoadViewCampaigns);
// View details modal
async function viewCampaignDetails(id) {
  const modal = E('campaign-details-modal');
  E('details-campaign-id').textContent = id;
  E('details-type').textContent = '...';
  E('details-sender').textContent = 'Loading...';
  E('details-subject').textContent = 'Loading...';
  E('details-body').innerHTML = 'Loading...';
  const table = E('details-contacts-table');
  while (table.rows.length > 1) table.deleteRow(1);
  modal.classList.add('active');
  try {
    const q = `SELECT sender, subject, body, contact_ids, type FROM campaigns WHERE campaign_id='${id}'`;
    const resp = await p.sendQuery(q);
    const campaign = resp.data.query1[0];
    E('details-type').textContent = campaign.type;
    E('details-sender').textContent = campaign.sender;
    E('details-subject').textContent = campaign.subject || '-';
    E('details-body').innerHTML = campaign.body || '-'; // Use innerHTML for HTML body rendering

    const contactIds = campaign.contact_ids.split(',').map(id => id.trim()).filter(Boolean);
    if (contactIds.length > 0) {
      const contactsQ = `SELECT contact_id, contact_name, contact_phone, contact_email FROM contacts WHERE contact_id IN (${contactIds.join(',')})`;
      const contactsResp = await p.sendQuery(contactsQ);
      const contacts = contactsResp.data.query1 || [];
      contacts.forEach(c => {
        const row = table.insertRow();
        row.insertCell().textContent = c.contact_id;
        row.insertCell().textContent = c.contact_name || '-';
        row.insertCell().textContent = c.contact_phone || '-';
        row.insertCell().textContent = c.contact_email || '-';
      });
    } else {
      const row = table.insertRow();
      row.insertCell().colSpan = 4;
      row.cells[0].textContent = 'No contacts';
    }
  } catch (err) {
    console.error(err);
    try { p.Toast.fire({ icon: 'error', title: 'Failed to load details' }); } catch (_) {}
  }
}
function closeDetailsModal() {
  E('campaign-details-modal').classList.remove('active');
}
// Duplicate campaign (full duplicate via contact IDs)
async function duplicateCampaign(id) {
  try {
    const q = `SELECT * FROM campaigns WHERE campaign_id='${id}'`;
    const resp = await p.sendQuery(q);
    const campaign = resp.data.query1[0];
    if (!campaign) throw new Error('Campaign not found');

    // Switch to compose tab
    campaignShowTab('campaign-tab-compose');

    // Pre-fill form
    document.querySelector(`input[name="campaign-type"][value="${campaign.type === 'email' ? 'simple-email' : (campaign.type === 'sms' ? 'sms' : 'html-email')}"]`).checked = true;
    campaignToggleFields();

    if (campaign.type === 'sms') {
      E('campaign-sms-phone').value = campaign.sender;
      E('campaign-sms-body').value = campaign.body;
    } else {
      E('campaign-email-address').value = campaign.sender;
      E('campaign-email-subject').value = campaign.subject;
      if (campaign.type === 'email') {
        quillBody.root.innerHTML = campaign.body;
      } else {
        E('campaign-html-body').value = campaign.body;
      }
    }

    // Reset schedule
    E('campaign-send-now').checked = true;
    campaignToggleSchedule();

    // Duplicate contacts: fetch and populate table
    const contactIds = campaign.contact_ids.split(',').map(id => id.trim()).filter(Boolean);
    if (contactIds.length > 0) {
      const contactsQ = `SELECT * FROM contacts WHERE contact_id IN (${contactIds.join(',')})`;
      const contactsResp = await p.sendQuery(contactsQ);
      const results = contactsResp.data.query1 || [];
      const table = E('campaign-reports-table');
      while (table.rows.length > 1) table.deleteRow(1);
      results.forEach((contact, index) => {
        const row = table.insertRow();
        const checkboxCell = row.insertCell();
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.id = `campaign-contact-checkbox-${index}`;
        checkboxCell.appendChild(checkbox);
        ['contact_id', 'contact_name', 'contact_phone', 'contact_email', 'contact_tags'].forEach(field => {
          const cell = row.insertCell();
          if (field === 'contact_id') {
            const escapedName = contact.contact_name ? contact.contact_name.replace(/'/g,"\\'") : '';
            cell.innerHTML = `<a href="#" onclick="window.parent.addFile('${escapedName}','contact','${contact.contact_id}')">${contact.contact_id}</a>`;
          } else {
            cell.textContent = contact[field] || '-';
          }
        });
      });
    }

    try { p.Toast.fire({ icon: 'success', title: 'Campaign duplicated - edit and create!' }); } catch (_) {}
  } catch (err) {
    console.error(err);
    try { p.Toast.fire({ icon: 'error', title: 'Failed to duplicate campaign' }); } catch (_) {}
  }
}
// Cancel campaign
async function cancelCampaign(id) {
  try {
    await p.sendQuery(`UPDATE campaigns SET status='canceled' WHERE campaign_id='${id}' AND status='scheduled'`);
    try { p.Toast.fire({icon:'success',title:`Campaign ${id} canceled.`}); } catch(_){}; 
    campaignLoadViewCampaigns();
  } catch (err) {
    console.error(err); 
    try { p.Toast.fire({icon:'error',title:'Failed to cancel campaign.'}); } catch(_){} 
  }
}
// View stats modal
async function viewCampaignStats(id) {
  const modal = E('campaign-stats-modal');
  E('stats-campaign-id').textContent = id;
  E('stats-total').textContent = 'Loading...';
  E('stats-sent').textContent = 'Loading...';
  E('stats-failed').textContent = 'Loading...';
  const table = E('stats-results-table');
  while (table.rows.length > 1) table.deleteRow(1);
  modal.classList.add('active');
  try {
    const q = `SELECT COUNT(*) AS total, 
               SUM(CASE WHEN status='sent' THEN 1 ELSE 0 END) AS sent,
               SUM(CASE WHEN status='failed' THEN 1 ELSE 0 END) AS failed
               FROM campaign_results WHERE campaign_id='${id}'`;
    const summaryResp = await p.sendQuery(q);
    const summary = summaryResp.data.query1[0];
    E('stats-total').textContent = summary.total || 0;
    E('stats-sent').textContent = summary.sent || 0;
    E('stats-failed').textContent = summary.failed || 0;

    const detailsQ = `SELECT * FROM campaign_results WHERE campaign_id='${id}'`;
    const detailsResp = await p.sendQuery(detailsQ);
    const results = detailsResp.data.query1 || [];
    results.forEach(r => {
      const row = table.insertRow();
      row.insertCell().textContent = r.contact_id;
      row.insertCell().textContent = r.status;
      row.insertCell().textContent = r.error || '-';
    });
  } catch (err) {
    console.error(err);
    try { p.Toast.fire({ icon: 'error', title: 'Failed to load stats' }); } catch (_) {}
  }
}
function closeStatsModal() {
  E('campaign-stats-modal').classList.remove('active');
}
// Placeholder insertion
function insertSelectedPlaceholder() {
  const select = document.getElementById('placeholder-selector');
  const value = select.value;
  if (!value) return;
  const placeholder = `{{contact.${value}}}`;
  if (!lastFocusedElement) {
    navigator.clipboard.writeText(placeholder).then(() => {
      alert(`No field focused. Copied: ${placeholder}\nPaste where you want it.`);
    });
    return;
  }
  // For Quill editor
  if (lastFocusedElement.classList.contains('ql-editor')) {
    quillBody.focus(); // Re-focus if needed
    const range = quillBody.getSelection(true);
    quillBody.insertText(range ? range.index : 0, placeholder);
    quillBody.setSelection(range ? range.index + placeholder.length : placeholder.length);
    return;
  }
  // For regular input or textarea
  if (lastFocusedElement.tagName === 'TEXTAREA' || lastFocusedElement.tagName === 'INPUT') {
    const start = lastFocusedElement.selectionStart;
    const end = lastFocusedElement.selectionEnd;
    lastFocusedElement.value =
      lastFocusedElement.value.substring(0, start) +
      placeholder +
      lastFocusedElement.value.substring(end);
   
    lastFocusedElement.selectionStart = lastFocusedElement.selectionEnd = start + placeholder.length;
    lastFocusedElement.focus();
    return;
  }
  // Fallback
  navigator.clipboard.writeText(placeholder).then(() => {
    alert(`Copied: ${placeholder}\nPaste where you want it.`);
  });
}
</script>
</body>
</html>