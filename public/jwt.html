<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JWT DB Playground</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    margin: 2rem;
    background: #f8f9fa;
  }
  h1 {
    color: #222;
  }
  textarea {
    width: 100%;
    height: 100px;
    font-family: monospace;
    font-size: 14px;
    padding: 0.5rem;
    border-radius: 5px;
    border: 1px solid #ccc;
    resize: vertical;
    background: #1e1e1e;
    color: #d4d4d4;
  }
  button {
    padding: 0.5rem 1rem;
    font-size: 16px;
    margin-top: 0.5rem;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #07ADEF;
    color: white;
  }
  button:hover { background: #0593c2; }
  .output-container {
    margin-top: 1rem;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1rem;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid #ccc;
    padding: 0.5rem 0.7rem;
    text-align: left;
  }
  th {
    background: #f0f0f0;
  }
  tr:nth-child(even) { background: #fafafa; }
  tr:hover { background: #f1f9ff; }
  .error { color: red; font-weight: bold; }
  .user-info { margin-bottom: 0.5rem; font-style: italic; }
</style>
</head>
<body>

<h1>JWT DB Playground</h1>

<label for="query">Enter your SQL query (use `|||` to separate multiple queries):</label>
<textarea id="query">SELECT 1 AS col1|||SELECT 2 AS col2</textarea>
<br>
<button id="btnQuery">Run Query</button>

<div id="output" class="output-container"></div>

<script>
/* --------------------- Blocking login --------------------- */
async function login() {
  const { value: formValues } = await Swal.fire({
    title: "Please log in",
    html: `
      <input id="username" class="swal2-input" placeholder="Username">
      <input id="password" type="password" class="swal2-input" placeholder="Password">
    `,
    focusConfirm: false,
    preConfirm: () => {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      if (!username || !password) Swal.showValidationMessage("Enter both username & password");
      return { username, password };
    },
    allowOutsideClick: false,
    allowEscapeKey: false
  });

  if (!formValues) throw new Error("Login cancelled");

  const resp = await fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formValues)
  });
  const data = await resp.json();
  if (!resp.ok || !data.token) {
    Swal.fire({ icon: "error", title: "Login Failed", text: data.error || "Unknown error" });
    return login();
  }

  localStorage.setItem("jwt", data.token);
}

/* --------------------- JWT validity check --------------------- */
function isJwtValid(token) {
  if (!token) return false;
  try {
    const payloadBase64 = token.split(".")[1];
    const payloadJson = atob(payloadBase64.replace(/-/g, "+").replace(/_/g, "/"));
    const payload = JSON.parse(payloadJson);
    const now = Math.floor(Date.now() / 1000);
    return payload.exp && payload.exp > now;
  } catch (err) {
    return false;
  }
}

/* --------------------- API call --------------------- */
async function apiSend(endpoint, method = "GET", payload = null) {
  let token = localStorage.getItem("jwt");

  if (!isJwtValid(token)) {
    await login();
    token = localStorage.getItem("jwt");
    if (!token) throw new Error("Login required");
  }

  let url = endpoint;
  const options = {
    method,
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    }
  };

  if (method === "GET" && payload) {
    url += "?" + new URLSearchParams(payload).toString();
  } else if (payload) {
    options.body = JSON.stringify(payload);
  }

  const res = await fetch(url, options);
  if (res.status === 401) {
    await login();
    token = localStorage.getItem("jwt");
    options.headers["Authorization"] = `Bearer ${token}`;
    return apiSend(endpoint, method, payload); // retry once
  }

  const data = await res.json();
  if (!res.ok) throw new Error(data.error || "API error");
  return data;
}

/* --------------------- Render results as table --------------------- */
function renderResults(data) {
  const container = document.getElementById("output");
  container.innerHTML = "";

  if (data.error) {
    container.innerHTML = `<div class="error">${data.error}</div>`;
    return;
  }

  if (data.auth) {
    container.innerHTML += `<div class="user-info">Logged in as <strong>${data.auth.username}</strong> (${data.auth.user_auth})</div>`;
  }

  for (const key in data.data) {
    const rows = data.data[key];
    if (!Array.isArray(rows)) {
      container.innerHTML += `<div class="error">${key}: ${rows.error || "Error"}</div>`;
      continue;
    }

    if (rows.length === 0) {
      container.innerHTML += `<div>${key}: No rows returned</div>`;
      continue;
    }

    const columns = Object.keys(rows[0]);
    let table = `<div><strong>${key}</strong><table><thead><tr>`;
    columns.forEach(col => table += `<th>${col}</th>`);
    table += `</tr></thead><tbody>`;
    rows.forEach(row => {
      table += `<tr>${columns.map(col => `<td>${row[col]}</td>`).join("")}</tr>`;
    });
    table += `</tbody></table></div>`;

    container.innerHTML += table;
  }
}

/* --------------------- Run query --------------------- */
document.getElementById("btnQuery").addEventListener("click", async () => {
  const container = document.getElementById("output");
  container.textContent = "Loading...";
  container.classList.remove("error");

  try {
    const query = document.getElementById("query").value.trim();
    if (!query) throw new Error("Query cannot be empty");

    const data = await apiSend(`/db-jwt?query=${encodeURIComponent(query)}`);
    renderResults(data);
  } catch (err) {
    container.innerHTML = `<div class="error">Error: ${err.message}</div>`;
  }
});

/* --------------------- Page load login check --------------------- */
(async () => {
  const token = localStorage.getItem("jwt");
  if (!isJwtValid(token)) {
    await login();
  }
})();
</script>
</body>
</html>
